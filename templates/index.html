<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document Chatbot</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
        }
        body {
            background: linear-gradient(135deg, #c3ecff, #f6f6ff);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
        }
        
        /* Auth forms styling */
        .auth-container {
            width: 100%;
            max-width: 400px;
            background: #f7faff;
            border: 2px solid #b3d8ff;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .auth-form h2 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }
        
        .auth-form input {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .auth-form input:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
        }
        
        .auth-form button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .auth-form button[type="submit"] {
            background: #007bff;
            color: white;
        }
        
        .auth-form button[type="submit"]:hover {
            background: #0056b3;
        }
        
        .auth-toggle {
            text-align: center;
            margin-top: 15px;
            color: #555;
        }
        
        .auth-toggle a {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
        }
        
        .auth-toggle a:hover {
            text-decoration: underline;
        }
        
        .user-info {
            width: 100%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;   /* Center horizontally */
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            text-align: center;        /* Center text inside */
        }
        
        .user-info p {
            font-weight: 500;
            color: #333;
        }
        
        .user-info button {
            padding: 8px 15px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .user-info button:hover {
            background: #c82333;
        }
        
        .app-content {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        h1 {
            font-size: 2.8em;
            margin-bottom: 20px;
            color: #222;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }
        
        #upload-area {
            background: #fff;
            border: 2px solid #b3d8ff;
            border-radius: 15px;
            padding: 30px;
            width: 100%;
            max-width: 600px;
            text-align: center;
            margin-bottom: 40px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        #upload-area:hover {
            border-color: #007bff;
            transform: translateY(-2px);
        }
        
        #upload-area.highlight {
            border-color: #007bff;
            background: rgba(0, 123, 255, 0.05);
        }
        
        #file-input {
            display: none;
        }
        
        .upload-btn {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            display: inline-block;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,123,255,0.3);
        }
        
        .upload-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        #status {
            margin-top: 15px;
            font-weight: 500;
            color: #333;
            min-height: 24px;
        }

        #chatbox {
            border: 2px solid #b3d8ff;
            background: #fafdff;
            width: 100%;
            max-width: 600px;
            height: 400px;
            overflow-y: auto;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            margin: 10px 0;
            border-radius: 12px;
            line-height: 1.6;
            font-size: 1em;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-in-out;
        }

        .user {
            background: #d0f0ff;
            margin-left: auto;
            border-bottom-right-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .bot {
            background: #fff;
            margin-right: auto;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .bot ul, .bot ol {
            padding-left: 20px;
            margin: 8px 0;
        }
        
        .bot li {
            margin-bottom: 6px;
        }
        
        .typing-indicator {
            display: inline-flex;
            padding: 8px 16px;
            background: #f1f1f1;
            border-radius: 18px;
            margin: 5px 0;
            align-items: center;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: #666;
            border-radius: 50%;
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        #input-area {
            display: flex;
            justify-content: center;
            width: 100%;
            max-width: 600px;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        #question-input {
            padding: 12px 16px;
            flex: 1;
            border: none;
            border-radius: 12px;
            outline: none;
            font-size: 1em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        #question-input:focus {
            box-shadow: 0 2px 12px rgba(0,123,255,0.2);
        }
        
        #ask-btn {
            padding: 12px 20px;
            font-size: 1em;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,123,255,0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #ask-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        #ask-btn:active {
            transform: translateY(0);
        }
        
        #ask-btn i {
            font-size: 0.9em;
        }

        .disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 600px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 10px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .download-section {
            background: rgba(255,255,255,0.8);
            border-radius: 15px;
            padding: 20px;
            width: 100%;
            max-width: 600px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        .download-section h3 {
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }

        .download-btns {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .download-btn {
            padding: 10px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .download-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .quick-actions {
            width: 100%;
            max-width: 600px;
            margin: 10px 0 10px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .quick-actions .download-btns {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .quick-actions .download-btn {
            padding: 8px 10px;
            font-size: 0.95em;
            border-radius: 6px;
            background: #28a745;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background 0.2s;
        }
        .quick-actions .download-btn:hover {
            background: #218838;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            justify-content: center;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 0.9em;
            margin-top: 5px;
            text-align: center;
        }
        
        .success-message {
            color: #28a745;
            font-size: 0.9em;
            margin-top: 5px;
            text-align: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }
        
        /* Hide app content when not logged in */
        .hidden {
            display: none !important;
        }

        /* Menu styles */
        .menu-container {
            position: absolute;
            top: 30px;
            right: 40px;
            z-index: 100;
        }

        .menu-btn {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 1.3em;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,123,255,0.2);
            transition: background 0.2s;
        }

        .menu-btn:hover {
            background: #0056b3;
        }

        .menu-dropdown {
            display: none;
            position: absolute;
            top: 48px;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.13);
            min-width: 210px;
            padding: 10px 0;
            flex-direction: column;
            gap: 0;
        }

        .menu-dropdown .menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            color: #222;
            text-decoration: none;
            background: none;
            border: none;
            width: 100%;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.2s;
            text-align: left;
        }

        .menu-dropdown .menu-item:hover {
            background: #f1f1f1;
        }

        .menu-dropdown .logout-btn {
            color: #dc3545;
        }

        .menu-dropdown .logout-btn:hover {
            background: #ffeaea;
        }

        .bot-title {
            font-family: 'Poppins', sans-serif;
            font-size: 2.8em;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
            letter-spacing: 1px;
            color: #222;
            text-shadow: 1px 2px 8px rgba(0,123,255,0.08);
            position: relative;
            line-height: 1.1;
        }

        .bot-title .logo-icon {
            font-size: 1.2em;
            margin-right: 10px;
            vertical-align: middle;
            color: #007bff;
            filter: drop-shadow(0 2px 4px #c3ecff);
        }

        .bot-title .main-name {
            color: #007bff;
            letter-spacing: 2px;
        }

        .bot-title .accent-name {
            color: #28a745;
            letter-spacing: 2px;
        }

        .bot-title .tagline {
            display: block;
            font-size: 0.38em;
            font-weight: 400;
            color: #555;
            margin-top: 8px;
            letter-spacing: 0.5px;
        }

        #link-area {
            margin-top: 20px;
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #link-input {
            width: 70%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1em;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        #link-input:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
        }

        #link-upload-btn {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            display: inline-block;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,123,255,0.3);
        }

        #link-upload-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        #link-status {
            margin-top: 10px;
            font-weight: 500;
            color: #28a745;
            min-height: 24px;
            text-align: center;
        }

        .main-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        .side-panel {
            background: #f8f9fa;
            border-right: 2px solid #d0e2ff;
            box-shadow: 2px 0 8px rgba(0,123,255,0.04);
            width: 320px;
            padding: 30px 15px 15px 15px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            min-width: 250px;
        }

        #upload-area {
            margin-bottom: 40px;
            border: 2px solid #b3d8ff;
            background: #fff;
        }

        #history-panel {
            flex: 1;
            overflow-y: auto;
        }

        #history-panel h3 {
            margin-bottom: 10px;
            color: #007bff;
            font-size: 1.1em;
            text-align: left;
        }

        #history-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #history-list li {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #fff;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.98em;
        }

        #history-list li:hover, #history-list li.active {
            background: #e3f0ff;
        }

        .chat-panel {
            background: linear-gradient(135deg, #e8f7ff 80%, #f6f6ff 100%);
            border-radius: 0 18px 18px 0;
            box-shadow: 0 2px 16px rgba(0,123,255,0.07);
            margin: 30px 0;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 30px;
            background: linear-gradient(135deg, #c3ecff, #f6f6ff);
            min-width: 0;
        }

        #user-info-bar {
            position: absolute;
            top: 20px;
            right: 40px;
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            padding: 10px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 200;
        }
        #user-info-bar p {
            margin: 0;
            font-weight: 500;
            color: #222;
        }
        #logout-btn-top {
            padding: 7px 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.98em;
            cursor: pointer;
            transition: background 0.2s;
        }
        #logout-btn-top:hover {
            background: #c82333;
        }

        .toggle-history-btn {
            position: absolute;
            top: 60px;
            left: 320px;
            z-index: 101;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,123,255,0.13);
            transition: left 0.3s cubic-bezier(.4,2,.6,1), background 0.2s;
        }
        .toggle-history-btn.collapsed {
            left: 10px;
            background: #28a745;
        }
        .toggle-history-btn i {
            transition: transform 0.3s;
        }
        .side-panel.collapsed {
            display: none;
        }
        .main-container.history-collapsed .chat-panel {
            border-radius: 18px;
        }
        .edit-question-btn, .delete-history-btn {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            margin-left: 8px;
            font-size: 1em;
        }
        .edit-question-btn:hover, .delete-history-btn:hover {
            color: #dc3545;
        }
        #delete-all-history-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1em;
            margin-left: 10px;
        }
    </style>
</head>
<body>
<div id="app-content" class="app-content hidden">
    <div class="main-container" id="main-container">
        <!-- Left Panel: Upload & History -->
        <div class="side-panel" id="side-panel">
            <div id="upload-area">
                <label for="file-input" class="upload-btn">
                    <i class="fas fa-upload"></i> Choose Document
                </label>
                <p id="status">Supports PDF, DOCX, TXT, CSV, XLSX files</p>
                <input type="file" id="file-input" accept=".pdf,.docx,.txt,.csv,.xlsx">
                <!-- Link upload area moved here and hidden by default -->
                <div id="link-area" style="margin-top:18px;">
                    <input type="text" id="link-input" placeholder="Paste article URL here..." />
                    <button id="link-upload-btn" class="upload-btn" style="margin-top:8px;">Analyze Link</button>
                    <div id="link-status"></div>
                </div>
            </div>
            <div id="history-panel">
                <h3>Chat History
                    <button id="delete-all-history-btn" title="Delete All" style="float:right;">
                        <i class="fas fa-trash"></i>
                    </button>
                </h3>
                <ul id="history-list"></ul>
            </div>
        </div>
        <!-- Toggle History Button -->
        <button id="toggle-history" class="toggle-history-btn hidden" title="Show/Hide History">
            <i class="fas fa-chevron-left"></i>
        </button>
        <!-- Right Panel: Chat -->
        <div class="chat-panel">
            <h1 class="bot-title">
                <span class="logo-icon">üìö</span>
                <span class="main-name">Docu</span><span class="accent-name">Mentor</span>
                <span class="tagline">Your Smart Document & Data Assistant</span>
            </h1>
            <div id="chatbox"></div>
            <div id="input-area">
                <input type="text" id="question-input" placeholder="Ask something about the document..." disabled>
                <button id="ask-btn" disabled>
                    <i class="fas fa-paper-plane"></i> Ask
                </button>
                <button id="pause-btn" title="Pause Bot" style="display:none;">
                    <i class="fas fa-pause"></i>
                </button>
            </div>
            <div class="checkbox-container">
                <input type="checkbox" id="use-context" checked>
                <label for="use-context">Use document context</label>
            </div>
        </div>
    </div>
</div>

<!-- Authentication Container -->
<div id="auth-container" class="auth-container">
    <div id="login-form" class="auth-form">
        <h2>Login</h2>
        <form id="login">
            <input type="text" id="login-username" placeholder="Username" required>
            <input type="password" id="login-password" placeholder="Password" required>
            <button type="submit">Login</button>
            <div id="login-error" class="error-message"></div>
        </form>
        <div class="auth-toggle">
            Don't have an account? <a href="#" id="show-register">Register</a>
        </div>
    </div>
    
    <div id="register-form" class="auth-form hidden">
        <h2>Register</h2>
        <form id="register">
            <input type="text" id="register-username" placeholder="Username" required>
            <input type="email" id="register-email" placeholder="Email" required>
            <input type="password" id="register-password" placeholder="Password" required>
            <button type="submit">Register</button>
            <div id="register-error" class="error-message"></div>
            <div id="register-success" class="success-message"></div>
        </form>
        <div class="auth-toggle">
            Already have an account? <a href="#" id="show-login">Login</a>
        </div>
    </div>
</div>

<!-- Hamburger menu for user actions -->
<div class="menu-container hidden" id="menu-container">
    <div class="side-panel" id="side-panel"></div>
    <button class="menu-btn" id="menu-btn" title="Menu">
        <i class="fas fa-bars"></i>
    </button>
    <div class="menu-dropdown" id="menu-dropdown">
        <a href="/download/text?format=txt" class="menu-item" title="Download Extracted Text as TXT">
            <i class="fas fa-file-alt"></i> Text as TXT
        </a>
        <a href="/download/text?format=pdf" class="menu-item" title="Download Extracted Text as PDF">
            <i class="fas fa-file-pdf"></i> Text as PDF
        </a>
        <a href="/download/chat?format=txt" class="menu-item" title="Download Chat History as TXT">
            <i class="fas fa-comments"></i> Chat as TXT
        </a>
        <a href="/download/chat?format=pdf" class="menu-item" title="Download Chat History as PDF">
            <i class="fas fa-comments"></i> Chat as PDF
        </a>
        <button id="logout-btn" class="menu-item logout-btn">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
    </div>
</div>

<!-- User Info Bar (Top Right) -->
<div id="user-info-bar" class="user-info hidden">
    <p>üë§ <span id="username-display"></span></p>
    <button id="logout-btn-top">Logout</button>
</div>

<!-- Toggle History Button -->
<button id="toggle-history" class="toggle-history-btn hidden" title="Show/Hide History">
    <i class="fas fa-chevron-left"></i>
</button>



<script>
    // DOM Elements
    const fileInput = document.getElementById('file-input');
    const uploadArea = document.getElementById('upload-area');
    const status = document.getElementById('status');
    const chatbox = document.getElementById('chatbox');
    const questionInput = document.getElementById('question-input');
    const askBtn = document.getElementById('ask-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const useContextCheckbox = document.getElementById('use-context');
    // Auth elements
    const authContainer = document.getElementById('auth-container');
    const loginForm = document.getElementById('login');
    const registerForm = document.getElementById('register');
    const showRegisterLink = document.getElementById('show-register');
    const showLoginLink = document.getElementById('show-login');
    const userInfoBar = document.getElementById('user-info-bar');
    const usernameDisplay = document.getElementById('username-display');
    const logoutBtnTop = document.getElementById('logout-btn-top');
    const logoutBtn = document.getElementById('logout-btn');
    const appContent = document.getElementById('app-content');
    // Login error elements
    const loginError = document.getElementById('login-error');
    const registerError = document.getElementById('register-error');
    const registerSuccess = document.getElementById('register-success');
    // App state
    let currentFile = null;
    let isBotTyping = false;
    let currentUsername = null;
    let isPaused = false;
    let currentTypingTimeout = null;

    document.addEventListener('DOMContentLoaded', () => {
        checkAuth();

        // Auth form toggles
        showRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
        });
        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
        });

        // Login form
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();
                if (response.ok) {
                    currentUsername = username;
                    updateUIAfterAuth();
                } else {
                    loginError.textContent = data.error || 'Login failed';
                }
            } catch (err) {
                loginError.textContent = 'Network error. Please try again.';
            }
        });

        // Register form
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            try {
                const response = await fetch('/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username, email, password })
                });
                if (response.ok) {
                    registerError.textContent = '';
                    registerSuccess.textContent = 'Registration successful! Please login.';
                    document.getElementById('register-form').classList.add('hidden');
                    document.getElementById('login-form').classList.remove('hidden');
                    registerForm.reset();
                } else {
                    const error = await response.json();
                    registerError.textContent = error.error || 'Registration failed';
                }
            } catch (err) {
                registerError.textContent = 'Network error. Please try again.';
            }
        });

        // Logout
        logoutBtn.addEventListener('click', async () => {
            try {
                await fetch('/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                currentUsername = null;
                updateUIAfterAuth();
                resetAppState();
            } catch (err) {
                console.error('Logout error:', err);
            }
        });
        logoutBtnTop.addEventListener('click', async () => {
            try {
                await fetch('/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                currentUsername = null;
                updateUIAfterAuth();
                resetAppState();
            } catch (err) {
                console.error('Logout error:', err);
            }
        });

        // File upload
        fileInput.addEventListener('change', handleFileUpload);

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('highlight');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('highlight');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('highlight');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileUpload();
            }
        });

        // Menu
        const menuContainer = document.getElementById('menu-container');
        const menuBtn = document.getElementById('menu-btn');
        const menuDropdown = document.getElementById('menu-dropdown');
        function updateMenuVisibility() {
            if (currentUsername) {
                menuContainer.classList.remove('hidden');
            } else {
                menuContainer.classList.add('hidden');
                menuDropdown.style.display = 'none';
            }
        }
        menuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            menuDropdown.style.display = menuDropdown.style.display === 'block' ? 'none' : 'block';
        });
        document.addEventListener('click', () => {
            menuDropdown.style.display = 'none';
        });
        document.querySelectorAll('.logout-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                try {
                    await fetch('/logout', {
                        method: 'POST',
                        credentials: 'include'
                    });
                    currentUsername = null;
                    updateUIAfterAuth();
                    resetAppState();
                } catch (err) {
                    console.error('Logout error:', err);
                }
            });
        });

        // Toggle history button
        const toggleHistoryBtn = document.getElementById('toggle-history');
        const sidePanel = document.getElementById('side-panel');
        const mainContainer = document.getElementById('main-container');

        toggleHistoryBtn.addEventListener('click', () => {
            sidePanel.classList.toggle('collapsed');
            mainContainer.classList.toggle('history-collapsed');
            toggleHistoryBtn.classList.toggle('collapsed');
            // Move the button with the panel
            if (sidePanel.classList.contains('collapsed')) {
                toggleHistoryBtn.style.left = '10px';
            } else {
                toggleHistoryBtn.style.left = '320px';
            }
            // Change chevron direction
            const icon = toggleHistoryBtn.querySelector('i');
            if (sidePanel.classList.contains('collapsed')) {
                icon.classList.remove('fa-chevron-left');
                icon.classList.add('fa-chevron-right');
            } else {
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-left');
            }
        });
        document.getElementById('delete-all-history-btn').onclick = async () => {
            if (confirm('Delete all chat history?')) {
                await fetch('/chat/clear', { method: 'POST', credentials: 'include' });
                loadChatHistoryList();
            }
        };
    });

    // Check authentication status
    async function checkAuth() {
        try {
            const response = await fetch('/api/check_auth', { credentials: 'include' });
            if (response.ok) {
                const data = await response.json();
                if (data.authenticated) {
                    currentUsername = data.username;
                    updateUIAfterAuth();
                    return true;
                }
            }
            authContainer.classList.remove('hidden');
            userInfoBar.classList.add('hidden');
            appContent.classList.add('hidden');
            return false;
        } catch (err) {
            console.error('Auth check error:', err);
            return false;
        }
    }

    // Update UI after authentication changes
    function updateUIAfterAuth() {
        const toggleHistoryBtn = document.getElementById('toggle-history');
        const linkArea = document.getElementById('link-area');
        if (currentUsername) {
            authContainer.classList.add('hidden');
            appContent.classList.remove('hidden');
            userInfoBar.classList.remove('hidden');
            usernameDisplay.textContent = currentUsername;
            // Clear chatbox on every login
            chatbox.innerHTML = '';
            loadChatHistoryList();
            toggleHistoryBtn.classList.remove('hidden'); // Show toggle button
            linkArea.style.display = 'block'; // Show link area
        } else {
            authContainer.classList.remove('hidden');
            appContent.classList.add('hidden');
            userInfoBar.classList.add('hidden');
            loginForm.reset();
            registerForm.reset();
            loginError.textContent = '';
            registerError.textContent = '';
            registerSuccess.textContent = '';
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
            toggleHistoryBtn.classList.add('hidden'); // Hide toggle button
            linkArea.style.display = 'none'; // Hide link area
        }
        updateMenuVisibility();
    }

    // Reset app state when logging out
    function resetAppState() {
        currentFile = null;
        chatbox.innerHTML = '';
        status.textContent = 'Supports PDF, DOCX, TXT, CSV, XLSX files';
        questionInput.value = '';
        questionInput.disabled = true;
        askBtn.disabled = true;
    }

    // Typing effect
    function typeResponse(element, text, delay = 20) {
        let i = 0;
        isPaused = false;
        document.getElementById('pause-btn').style.display = 'inline-block';
        function type() {
            if (isPaused) return;
            if (i < text.length) {
                if (text[i] === '\n') {
                    element.innerHTML += '<br>';
                    i++;
                } else if (text.substr(i, 2) === 'üîπ' || text.substr(i, 2) === '‚úÖ' || text.substr(i, 2) === 'üìå') {
                    element.innerHTML += text.substr(i, 2) + ' ';
                    i += 2;
                } else {
                    element.innerHTML += text[i];
                    i++;
                }
                currentTypingTimeout = setTimeout(type, delay);
            } else {
                document.getElementById('pause-btn').style.display = 'none';
            }
        }
        type();
    }
    document.getElementById('pause-btn').onclick = function() {
        isPaused = true;
        this.style.display = 'none';
        if (currentTypingTimeout) clearTimeout(currentTypingTimeout);
    };

    function createTypingIndicator() {
        const typing = document.createElement('div');
        typing.className = 'typing-indicator';
        typing.innerHTML = `
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        `;
        chatbox.appendChild(typing);
        chatbox.scrollTop = chatbox.scrollHeight;
        return typing;
    }

    function addMessage(text, sender, originalIdx = null) {
        const msg = document.createElement('div');
        msg.className = `message ${sender}`;
        if (sender === 'user') {
            msg.innerHTML = `<span class="msg-text">${text}</span>
                <button class="edit-question-btn" title="Edit"><i class="fas fa-edit"></i></button>`;
            msg.querySelector('.edit-question-btn').onclick = function() {
                questionInput.value = text;
                questionInput.focus();
            };
        } else {
            msg.textContent = text;
        }
        chatbox.appendChild(msg);
        chatbox.scrollTop = chatbox.scrollHeight;
    }

    async function handleFileUpload() {
        if (!fileInput.files.length) return;
        const file = fileInput.files[0];
        const allowedExtensions = ['pdf', 'docx', 'txt', 'csv', 'xlsx'];
        const fileExt = file.name.split('.').pop().toLowerCase();
        if (!allowedExtensions.includes(fileExt)) {
            status.textContent = '‚ùå Invalid file type. Please upload PDF, DOCX, TXT, CSV, or XLSX.';
            return;
        }
        const formData = new FormData();
        formData.append('file', file);
        try {
            status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            askBtn.disabled = true;
            questionInput.disabled = true;
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData,
                credentials: 'include'
            });
            const result = await response.json();
            if (response.ok) {
                currentFile = file.name;
                status.innerHTML = `<i class="fas fa-check-circle"></i> <strong>${file.name}</strong> ready for questions!`;
                questionInput.disabled = false;
                askBtn.disabled = false;
                questionInput.focus();
                addMessage(`Hey ${currentUsername}, you have uploaded "${file.name}". Ask me anything about it!`, 'bot');
            } else {
                status.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${result.error || 'Upload failed'}`;
            }
        } catch (error) {
            status.innerHTML = `<i class="fas fa-exclamation-circle"></i> Error: ${error.message}`;
        }
    }

    async function askQuestion() {
        const question = questionInput.value.trim();
        if (!question || !currentFile) return;
        addMessage(question, 'user');
        questionInput.value = '';
        askBtn.disabled = true;
        questionInput.disabled = true;
        const typingIndicator = createTypingIndicator();
        chatbox.appendChild(typingIndicator);
        chatbox.scrollTop = chatbox.scrollHeight;
        try {
            const response = await fetch('/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question, use_context: useContextCheckbox.checked }),
                credentials: 'include'
            });
            const result = await response.json();
            chatbox.removeChild(typingIndicator);
            if (response.ok) {
                addMessage(result.answer, 'bot');
                loadChatHistoryList();
            } else {
                addMessage(`Error: ${result.error || 'Failed to get answer'}`, 'bot');
            }
        } catch (error) {
            chatbox.removeChild(typingIndicator);
            addMessage(`Error: ${error.message}`, 'bot');
        } finally {
            askBtn.disabled = false;
            questionInput.disabled = false;
            questionInput.focus();
        }
    }

    // Load chat history list into the side panel (not chatbox)
    async function loadChatHistoryList() {
        try {
            const response = await fetch('/chat/history?limit=50', { credentials: 'include' });
            const data = await response.json();
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            if (data.chats && data.chats.length > 0) {
                data.chats.forEach((chat, idx) => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span class="history-question">${chat.question.slice(0, 40) + (chat.question.length > 40 ? '...' : '')}</span>
                        <button class="delete-history-btn" title="Delete"><i class="fas fa-trash"></i></button>
                    `;
                    li.title = chat.question;
                    li.onclick = (e) => {
                        if (e.target.closest('.delete-history-btn')) return;
                        chatbox.innerHTML = '';
                        addMessage(chat.question, 'user');
                        addMessage(chat.answer, 'bot');
                        document.querySelectorAll('#history-list li').forEach(el => el.classList.remove('active'));
                        li.classList.add('active');
                    };
                    li.querySelector('.delete-history-btn').onclick = async (e) => {
                        e.stopPropagation();
                        await fetch('/chat/delete_one', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ id: chat.id })
                        });
                        loadChatHistoryList();
                    };
                    historyList.appendChild(li);
                });
            } else {
                historyList.innerHTML = '<li style="color:#888;">No history yet.</li>';
            }
        } catch (e) {
            document.getElementById('history-list').innerHTML = '<li style="color:#888;">Failed to load history.</li>';
        }
    }

    // Event listeners
    askBtn.addEventListener('click', askQuestion);
    questionInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !askBtn.disabled) askQuestion();
    });

    // Drag and drop functionality already handled above

    // Link upload (if you have a link upload area)
    const linkInput = document.getElementById('link-input');
    const linkUploadBtn = document.getElementById('link-upload-btn');
    const linkStatus = document.getElementById('link-status');

    linkUploadBtn.addEventListener('click', async () => {
        const url = linkInput.value.trim();
        if (!url) {
            linkStatus.textContent = "Please enter a valid link.";
            return;
        }
        linkStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fetching and analyzing...';
        askBtn.disabled = true;
        questionInput.disabled = true;
        try {
            const response = await fetch('/upload_link', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ url })
            });
            const result = await response.json();
            if (response.ok) {
                currentFile = url;
                linkStatus.innerHTML = `<i class="fas fa-check-circle"></i> Link analyzed! Ask me anything about it.`;
                questionInput.disabled = false;
                askBtn.disabled = false;
                questionInput.focus();
                const displayTitle = result.page_title || url;
                addMessage(`Hey ${currentUsername}, you have uploaded the article "${displayTitle}". Ask me anything about it!`, 'bot');
            } else {
                linkStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${result.error || 'Failed to analyze link.'}`;
            }
        } catch (error) {
            linkStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> Error: ${error.message}`;
        }
    });
</script>
</body>
</html>